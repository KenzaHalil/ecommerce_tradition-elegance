{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h1>Paiement</h1>

  <p>Commande : <strong>{{ order_id }}</strong></p>
  <p>Montant à payer : <strong>{{ amount_eur | round(2) }} €</strong></p>

  <form id="payForm" method="post" class="mt-3" style="max-width:420px;">
    <div class="mb-2">
      <label class="form-label">Numéro de carte</label>
      <input id="card_number" name="card_number" class="form-control" placeholder="4242424242424242" required>
      <div id="card_error" class="text-danger small mt-1" style="display:none;"></div>
    </div>
    <div class="row">
      <div class="col-6 mb-2">
        <label class="form-label">Mois (MM)</label>
        <input name="exp_month" type="number" min="1" max="12" class="form-control" required>
      </div>
      <div class="col-6 mb-2">
        <label class="form-label">Année (YYYY)</label>
        <input name="exp_year" type="number" min="2025" class="form-control" required>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">CVC</label>
      <input name="cvc" class="form-control" placeholder="123" required>
    </div>

    <button id="payBtn" type="submit" class="btn btn-success">Payer {{ amount_eur | round(2) }} €</button>
    <a href="{{ url_for('checkout.checkout') }}" class="btn btn-link ms-2">Retour</a>
  </form>
</div>

<script>
function luhnCheck(num) {
  const s = num.replace(/\D/g, '');
  if (s.length < 12) return false;
  let sum = 0, alt = false;
  for (let i = s.length - 1; i >= 0; i--) {
    let n = parseInt(s[i], 10);
    if (alt) { n *= 2; if (n > 9) n -= 9; }
    sum += n;
    alt = !alt;
  }
  return sum % 10 === 0;
}

document.getElementById('payForm').addEventListener('submit', function(e){
  const num = document.getElementById('card_number').value || '';
  const err = document.getElementById('card_error');
  if (!luhnCheck(num)) {
    e.preventDefault();
    err.style.display = 'block';
    err.textContent = 'Numéro de carte invalide.';
    return false;
  }
  err.style.display = 'none';
});
</script>
{% endblock %}